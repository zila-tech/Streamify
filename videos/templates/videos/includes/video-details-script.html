<script>
  const videoPlayer = document.getElementById('videoPlayer');
  const playPauseBtn = document.getElementById('playPauseBtn');
  const seeker = document.getElementById('seeker');
  const volumeBtn = document.getElementById('volumeBtn');
  const fullScreenBtn = document.getElementById('fullScreenBtn');
  const restartBtn = document.getElementById('restartBtn');
  const shareBtn = document.getElementById('share');
  const detailCard = document.getSelection('.card-header');
  const timeStampEl = document.getElementById('timestamp');
  const totalTimeEl = document.getElementById('totalTime');
  const currentVideoId = '{{ video.id }}';
   let isSeeking = false;

  function fullScreenFunc() {
    if (videoPlayer.requestFullscreen) {
      videoPlayer.requestFullscreen();
    } else if (videoPlayer.mozRequestFullScreen) {
      videoPlayer.mozRequestFullScreen();
    } else if (videoPlayer.webkitRequestFullscreen) {
      videoPlayer.webkitRequestFullscreen();
    } else if (videoPlayer.msRequestFullscreen) {
      videoPlayer.msRequestFullscreen();
    }
  }  

  document.querySelector('.card-header').addEventListener('click', function () {
    this.querySelector('.fa').classList.toggle('fa-chevron-down');
    this.querySelector('.fa').classList.toggle('fa-chevron-up');
  });

  shareBtn.addEventListener('click', function () {
    var shareModal = new bootstrap.Modal(document.getElementById('shareModal'));
    shareModal.show();
  });

  document.getElementById('copyBtn').addEventListener('click', function () {
    var copyText = document.getElementById('shareUrl');
    copyText.select();
    document.execCommand('copy');
    showToast("Info", "URL copied to clipboard!", "info");
  });

  const videoUrl = '{{ request.build_absolute_uri }}';
  
  document.getElementById('facebookShare').addEventListener('click', function() {
    const url = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(videoUrl)}`;
    window.open(url, '_blank', 'width=600,height=400');
  });

  document.getElementById('twitterShare').addEventListener('click', function() {
    const url = `https://twitter.com/intent/tweet?url=${encodeURIComponent(videoUrl)}&text=Check%20out%20this%20video`;
    window.open(url, '_blank', 'width=600,height=400');
  });

  document.getElementById('googlePlusShare').addEventListener('click', function() {
    const url = `https://plus.google.com/share?url=${encodeURIComponent(videoUrl)}`;
    window.open(url, '_blank', 'width=600,height=400');
  });

  document.getElementById('linkedinShare').addEventListener('click', function() {
    const url = `https://www.linkedin.com/shareArticle?url=${encodeURIComponent(videoUrl)}`;
    window.open(url, '_blank', 'width=600,height=400');
  });

  // Hide default controls
  videoPlayer.controls = false;
  let clickCount = 0;
  let singleClickTimer;

  function pauseFuc(params) {
    videoPlayer.pause();
    playPauseBtn.classList.remove('fa-pause');
    playPauseBtn.classList.add('fa-play');
    playPauseBtn.title = 'Play';
  }
  function playPauseFunc() {
    if (videoPlayer.paused) {
      videoPlayer.play();
      playPauseBtn.classList.remove('fa-play');
      playPauseBtn.classList.add('fa-pause');
      playPauseBtn.title = 'Pause';
    } else {
      pauseFuc()
    }
    totalTimeEl.textContent = formatTime(videoPlayer.duration);
  }

  // Format time in MM:SS
  function formatTime(time) {
    const mins = Math.floor(time / 60);
    const secs = Math.floor(time % 60);
    return `${mins < 10 ? '0' : ''}${mins}:${secs < 10 ? '0' : ''}${secs}`;
  }

  playPauseBtn.addEventListener('click', () => {
    playPauseFunc();
  });

  // Adjust volume on slider change
  volumeSlider.addEventListener('input', () => {
    videoPlayer.volume = volumeSlider.value;
    if (videoPlayer.volume === 0) {
      videoPlayer.muted = true;
      volumeBtn.classList.remove('fa-volume-up');
      volumeBtn.classList.add('fa-volume-off');
    } else {
      videoPlayer.muted = false;
      volumeBtn.classList.remove('fa-volume-off');
      volumeBtn.classList.add('fa-volume-up');
    }
  });

  videoPlayer.addEventListener('timeupdate', () => {
    console.log("videoPlayer: ",(videoPlayer.currentTime / videoPlayer.duration) * 100)
    if (!isSeeking) {
      const value = (videoPlayer.currentTime / videoPlayer.duration) * 100;
      seeker.value = value;
      timeStampEl.textContent=formatTime(videoPlayer.currentTime);
    }
  });

  videoPlayer.addEventListener('ended', function() {
    pauseFuc()
  });

  seeker.addEventListener('input', () => {
    isSeeking = true;
    const time = (seeker.value / 100) * videoPlayer.duration;
    videoPlayer.currentTime = time;
    timeStampEl.textContent = formatTime(videoPlayer.currentTime);
  });

  // Stop seeking once the input change is complete
  seeker.addEventListener('change', () => {
    isSeeking = false;
  });

  volumeBtn.addEventListener('click', () => {
    if (videoPlayer.muted) {
      videoPlayer.muted = false;
      volumeBtn.classList.remove('fa-volume-off');
      volumeBtn.classList.add('fa-volume-up');
      volumeBtn.title = 'Mute';
    } else {
      videoPlayer.muted = true;
      volumeBtn.classList.remove('fa-volume-up');
      volumeBtn.classList.add('fa-volume-off');
      volumeBtn.title = 'Unmute';
    }
  });

  // Event listener for double click
  videoPlayer.addEventListener('click', () => {
    playPauseFunc();
    clickCount++;

    if (clickCount === 1) {
      // Set a timer to reset click count after 300ms
      singleClickTimer = setTimeout(() => {
        clickCount = 0;
      }, 300);
    } else if (clickCount === 2) {
      clearTimeout(singleClickTimer);
      fullScreenFunc()
      clickCount = 0;
    }
  });

  fullScreenBtn.addEventListener('click', fullScreenFunc);

  restartBtn.addEventListener('click', () => {
    videoPlayer.currentTime = 0;
    videoPlayer.play();
    playPauseBtn.classList.remove('fa-play');
    playPauseBtn.classList.add('fa-pause');
  });

  prevBtn.addEventListener('click', () => {
    fetch(`/videos/get-prev-next-ids/${currentVideoId}/`)
      .then((response) => response.json())
      .then((data) => {
        if (data.prev_video_id) {
          window.location.href = `{% url 'video-detail' 1 %}`.replace(
            '1',
            data.prev_video_id
          );
        } else {
          prevBtn.classList.toggle('text-primary');
          prevBtn.classList.toggle('disabled');
        }
      });
  });

  nextBtn.addEventListener('click', () => {
    fetch(`/videos/get-prev-next-ids/${currentVideoId}/`)
      .then((response) => response.json())
      .then((data) => {
        if (data.next_video_id) {
          window.location.href = `{% url 'video-detail' 1 %}`.replace(
            '1',
            data.next_video_id
          );
        } else {
          nextBtn.classList.toggle('text-primary');
          nextBtn.classList.toggle('disabled');
        }
      });
  });
</script>